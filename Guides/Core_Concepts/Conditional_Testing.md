# 定義

条件テストは共通のプログラミング パターンを参照する: 

> もし X なら, Y, または Z

この方法でテストを書くと、最初はシンプルに見えるが壊れやすいテストになりやすい。ランダムに失敗し、原因を追及するのが難しくなる。

# 問題

**条件テスト**の問題は状態が安定している時にのみ使用できること。現代のアプリケーションでは、いつ状態が安定しているかを知ることはしばしば不可能。

# 状況

## サーバー サイド レンダリング

JavaScriptなしで非同期にDOMを変更するサーバー サイド レンダリングの場合は、`load`イベントの後でDOMの変更が行われないので、DOMで条件テストできる。

## クライアント サイド レンダリング

DOMで条件テストすることは不可能。不変な要素に基づきテストする必要がある。


# 戦略

- 条件テストの必要性をなくす
- アプリケーションの振る舞いを固定する
- 他のソース（サーバーやデータベース）の信頼性を確認する
- 読み込み可能な他の場所（Cookie／ローカル ストレージ）にデータを埋め込む
- 処理すべき方法が分かっているデータをDOMに追加する

## A/Bキャンペーン

どのキャンペーンを送るか制御するか、または、どちらか分かる手段を提供する。

### サーバーを使う

サーバーがセッションにキャンペーンを保存する場合は、サーバーに要求できる。

### セッション Cookieを使う

サーバーがセッションCookieにキャンペーンを保存する場合はより簡単になる。

### DOMにデータを埋め込む

DOMに直接データを埋め込む。このデータは常に存在していて検索可能な状態にする。

## ようこそウィザード

テスト対象のアプリケーションをロードする度に「ようこそウィザード」がモーダルで表示される機能があるとする。   

そのウィザードが存在する場合は閉じて、存在しない場合は無視したい。

このような状況における問題は、ウィザードが非同期にレンダリングされること。DOMを使ってテストできない。

### 制御するためにURLを使う

```javascript
// ウィザードを表示しない
cy.visit('https://app.com?wizard=0')
```

```javascript
// ウィザードを表示する
cy.visit('https://app.com?wizard=1')
```

### 前もって分かるようにCookieを使う

制御できない状況でも、表示されるかどうか分かっていれば条件的に閉じられる。

```javascript
cy.visit('https://app.com')
cy.getCookie('showWizard')
  .then((val) => {
    if (val) {
      // 3つの追加コマンドを
      // キューに格納することにより、ウィザードを条件的に閉じる
      cy.get('#wizard').contains('Close').click()
    }
  })
  .get(...)     // さらにコマンドを実行する
  .should(...)  // さらにコマンドを実行する
  .click()      // さらにコマンドを実行する
```

### サーバーまたはデータベースを使う

ウィザードを表示するかどうかをサーバーに保存・保持している場合は、サーバーから取得したデータを確認する。

### DOMにデータを埋め込む

## 要素の存在

DOMを使って条件テストを行う場合、制御フローを作り出すために要素を同期的に検索できるCypressの機能を使う。

不安定なテストを描いているかどうか不確かな場合は、テストを非常に多い回数で繰り返し実行し、ディベロッパー ツールでネットワークとCPUのパフォーマンスを落として繰り返し実行してみる。よいテストを書いていれば100％成功するか失敗するかのどちらかになる。

## 動的なテキスト

特定のテキストがあるかどうかに基づいて条件的に何かを行うパターンは、前述の要素の存在によるテストと同じ。

# エラーのリカバリー

サーバー エラーと同じなので、復旧はできない。エラーになった時点でテストは失敗し、ログに出力される。

