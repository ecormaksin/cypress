---
title: 要素とのやりとり
---

# 動作可能性

Cypressの中にはDOMとやりとりするコマンドがある。

例
- `.click()`
- `.dbclick()`
- `.type()`
- `.clear()`
- `.check()`
- `.uncheck()`
- `.select()`
- `.trigger()`

## 実行されるチェックと動作

- 要素が見える範囲までスクロールする。
- 要素が非表示でないことを確認する。
- 要素が使用不可でないことを確認する。
- 要素が読み取り専用でないことを確認する。
- 要素が動いていないことを確認する。
- 要素が覆われていないことを確認する。
- 位置固定の要素によってまだ覆われている場合はページをスクロールする。
- 望ましい座標でイベントを発火させる。

Cypressが対象の要素とやりとりできない場合は常に、上記のステップのいずれかで失敗する。通常、なぜ要素が動作可能な状態で見つからないかを説明するエラー情報を得られる。

## 可視性

Cypressは要素の可視性を判断するために多くのことをチェックする。

**要素がもし次の通りであれば隠れていると判定される:**

- 幅か高さが0。
- CSSプロパティ(または上位の要素)が`visibility: hidden`。
- CSSプロパティ(または上位の要素)が`display: none`。
- CSSプロパティが`position: fixed`で、表示範囲外か別の要素で覆われている。

**さらに、要素が次の通りであれば隠れていると判定される:**

- 上位要素のいずれかが**overflow*を隠している**
    - かつ、その上位要素が0の幅か高さを持っている。
    - かつ、上位要素と対象要素の間の要素が`position: absolute`。
- 上位要素のいずれかが**overflow*を隠している**
    - かつ、その上位要素か、その上位要素とそのまた上位要素の間の上位要素がオフセットの親である。（？理解できていない）
    - かつ、それが上位要素の境界の外側に配置されている。
- 上位要素のいずれかが**overflow*を隠している**
    - かつ、その要素が`position: relative`。
    - かつ、それが上位要素の境界の外側に配置されている。

**overflow*を隠している**とは、次のプロパティのいずれかを持っていることを意味する: `overflow: hidden`, `overflow-x: hidden`, `overflow-y: hidden`, `overflow: scroll`, `overflow: auto`

## 使用不可性

Cypressは要素の`disabled`プロパティが`true`かチェックする。

## 読み取り専用

Cypressは`.type()`の間に`readonly`プロパティがセットされているかチェックする。

## アニメーション

Cypressは要素が動いているかどうかを自動的に判定し、止まるまで待機する。

要素が動いているかを判定するために、その要素があった最後の位置を取得し、要素の傾きを計算する。（アメリカでは8年生の代数で学習する？）

要素が動いているかを判定するために、現在の位置と前の位置をチェックする。もし、その距離が[`animationDistanceThreshold`](https://docs.cypress.io/guides/references/configuration.html#Animations)を超えている場合は、その要素が動いていると判定する。

　[この閾値は変更できる。](https://docs.cypress.io/guides/references/configuration.html#Animations)

アニメーションに関するチェックは、[waitForAnimations](https://docs.cypress.io/guides/references/configuration.html#Animations)で無効にできる。

## 遮蔽

やりとりする要素が親要素に覆われていないこともチェックする。

---

要素が覆われていないかどうかは、常に中央の座標で判断する。

---

子の要素に覆われてる場合は問題ない。子の要素に対してイベントを発火する。

## スクロール

要素とやりとりする前に、Cypressは必ずその要素が表示領域に来るまでスクロールする。

---

スクロールは前述の動作可能なコマンドのみに適用される。`cy.get()`や`.find()`のようなDOMを使うコマンドではスクロールしない。

---

## 座標

通常、イベントは要素の中央で発火される。しかし、コマンドのほとんどは発火する位置を変更できる。

```javascript
cy.get('button').click({ position: 'topLeft' })
```

イベントを発火した座標は[コマンドログ](https://docs.cypress.io/guides/core-concepts/test-runner.html#Command-Log)で確認できる。

また、イベントの座標を示す赤い丸が表示される。

# デバッグ

コマンドごとのスナップショットやコマンドログを見るだけでは、操作コマンドが失敗した原因が分からないことがある。  
`debugger`ステートメントや操作コマンドの前で直接`.debug()`コマンドを使うことが推奨される。  
ディベロッパーツールで詳細な情報を確認する方がよい。

バージョン0.20.0以降は`.debug()`コマンドをイベントに紐付けられる。

```javascript
// 操作コマンドの前にデバッガーモードでブレークする
cy.get('button').debug().click()
```

# 強制

ユーザーの操作を再現したテストに価値がないこともある。

操作コマンドに`{ force: true }`を渡すことで、要素が操作可能でない状態でも強制的にイベントを発火させることができる。

```javascript
// 要素が'操作可能'な状態でなくても
// クリックと後続のすべてのイベントを強制的に発火させる
cy.get('button').click('{ force: true }')
```

---

違いは何か？

イベントを強制的に発火させた場合:
- すべてのデフォルト アクションが継続して実行される
- 強制的に要素のイベントが発火される

以下は実行されない:
- 要素が見えるようにスクロールする
- 見えているかチェックする
- 使用不可でないかチェックする
- 読み取り専用でないかチェックする
- 動いていないかチェックする
- 遮蔽されていないかチェックする
- 子要素のイベントを発火する

---

