# 要素の検索

- CypressとjQueryの違い
    - jQuery
        - 要素が見つからない時は空の集合を返す。そのため、存在チェックしなければならない。
    
    - Cypress
        - タイムアウトするまでDOMを検索する。見つからなかった時はエラーになる。

---
CypressでDOMの要素と直接やりとりする時は、第1引数にその要素を指定したコールバック関数を、`.then()`を使って呼び出す。
リトライ−タイムアウトの機能をスキップして従来のように処理したい時は、`Cypress.$.`を使う。
---

- テキストの中身で検索する時は`cy.contains()`を使う。

```
// 'New Post'というテキストを含む要素をドキュメントから検索する
cy.contains('New Post')

// '.main'の中で'New Post'というテキストを含む要素をドキュメントから検索する
cy.get('.main').contains('New Post')
```

## 要素が見つからない時

- すぐに失敗するのではなく、一定時間は要素を検索する。
- デフォルトのタイムアウトは4秒
- コマンドのオプションでタイムアウトの時間を指定できる。

```
// この要素については10秒待つ
cy.get('.my-slow-selector', { timeout: 10000 })
```

- 全体的なタイムアウトを変更する時は、`defaultCommandTimeout`を変更する。

# コマンドの連鎖

## コマンドは非同期

Cypressのコマンドは呼び出された直後には実行されない。テストの関数が終わるまでキューに格納され、順番に実行される。そのため、コマンドは非同期。

# アサーション

## いつアサートするべきか？

Cypressにおいて、もっともよいテストはアサーションをまったく行わないこと。どのようにして実現するか？

### 例

明示的なアサーションを行わなくても、以下のようなケースでテストは失敗しうる。

- `cy.visit()`がOKでは返ってこないかもしれない。
- `cy.get()`が対象の要素をDOMから見つけられずに失敗するかもしれない。
- `.click()`の対象要素が他の要素で隠れているかもしれない。
- `.type()`の対象要素が使用不可かもしれない。
- フォームのサブミットがOKでは返ってこないかもしれない。
- テスト対象のJavaScriptがエラーを投げるかもしれない。

Cypressのコマンドにはデフォルトのアサーションがビルトインされているものが多い。

## デフォルトのアサーション

---
`.should()`をつなげた場合、デフォルトの`.should('exist')`はアサートされない。これは、`.should('have.class')`のような肯定形なアサーションであれば要素の存在が暗黙の前提のため問題ない。しかし、`.should('not.have.class')`のような否定形のアサーションの場合は、要素が存在しない場合でもOKになってしまう。
---

# タイムアウト

## タイムアウトの適用

### 例3 タイムアウトの編集

タイムアウトはコマンドごとに変更できる。コマンドを連鎖させると、以降のタイムアウトすべてに影響する。

```
// デフォルトのタイムアウトと追加したアサーションに影響するタイムアウトを編集している
cy
    .get('.mobile-nav', { timeout: 10000 })
    .should('be.visible')
    .and('contain', 'Home')
```

## デフォルトの値

- `cy.visit()`: 60000ms（1分）
- `cy.exec()`: 60000ms（1分）
- `cy.wait()`: リクエスト 5000ms（5秒）、レスポンス 30000ms（30秒）
